<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIçŸ¥è¯†åº“</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .description {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .history-panel {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .history-title {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        .output-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .response-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #2c3e50;
        }

        .output-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .response-content {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 15px;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
        }

        .input-panel {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            align-items: center;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #34495e;
            font-size: 0.9rem;
        }

        select, textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
        }

        textarea {
            min-height: 100px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .btn-clear {
            background: #e74c3c;
        }

        .btn-clear:hover {
            background: #c0392b;
        }

        .status-bar {
            margin-top: 15px;
            padding: 10px 15px;
            background: #ecf0f1;
            border-radius: 5px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .history-item {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .history-item:hover {
            background: #f8f9fa;
        }

        .history-item.active {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .history-prompt {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .history-response {
            color: #7f8c8d;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.75rem;
            color: #95a5a6;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .active .spinner {
            display: block;
        }

        .token-counter {
            color: #3498db;
            font-weight: 600;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .context-toggle {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .empty-history {
            text-align: center;
            color: #95a5a6;
            padding: 20px;
            font-style: italic;
        }

        .shortcut-hint {
            font-size: 0.75rem;
            color: #95a5a6;
            margin-top: 5px;
            text-align: right;
        }

        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }

            .history-panel {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .input-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            textarea {
                min-height: 80px;
            }
        }
    </style>
</head>
<body>


<div class="main-content">
    <div class="history-panel">
        <div class="history-title">å¯¹è¯å†å²</div>
        <div id="history-list">
            <div class="empty-history">æš‚æ— å†å²è®°å½•</div>
        </div>
    </div>

    <div class="output-panel">
        <div class="response-header">æ¨¡å‹å“åº”</div>
        <div class="output-container">
            <div id="response" class="response-content">è¯·è¾“å…¥æç¤ºè¯å¹¶ç‚¹å‡»å‘é€...</div>
        </div>
    </div>
</div>

<div class="input-panel">
    <div class="input-container">
        <div class="input-group">
            <div class="upload-section">
                <form id="multiple-upload-form" enctype="multipart/form-data">
                    <input type="file" id="fileinput" name="files" class="file-input" multiple required>
                    <button type="submit" title="æ”¯æŒæ ¼å¼pdfï¼Œtxtï¼Œpptxï¼Œpptï¼Œxlsxï¼Œxlsï¼Œcsvï¼Œhtmlï¼Œhtmï¼Œmdï¼Œdocxï¼Œdoc">ä¸Šä¼ æ–‡ä»¶åˆ°çŸ¥è¯†åº“</button>
                </form>
                <div id="multiple-result"></div>
            </div>
            <label for="model">æ¨¡å‹é€‰æ‹©</label>
            <select id="model">
                <option value="Qwen/Qwen3-32B" selected>Qwen3 32B</option>
                <option value="Qwen/Qwen3-14B" >Qwen3 14B</option>
{#                <option value="Qwen/Qwen3-Coder-480B-A35B-Instruct">Qwen3-Coder-480B-A35B-Instruct</option>#}
                <option value="qwen3:1.7b" >Qwen3 1.7B</option>
                <option value="qwen3:0.6b">Qwen3 0.6B</option>
                <option value="qwen:0.5b">Qwen 0.5B</option>


            </select>


            <div class="context-toggle">
                <input type="checkbox" id="use-local-document" checked>
                <label for="use-local-document" style="font-weight: normal; margin-left: 5px;">æ£€ç´¢çŸ¥è¯†åº“</label>
            </div>
            <div class="context-toggle">
                <input type="checkbox" id="think">
                <label for="think" style="font-weight: normal; margin-left: 5px;">æ·±åº¦æ€è€ƒ</label>
            </div>
        </div>

        <div class="input-group">
            <label for="prompt">è¾“å…¥æç¤ºè¯</label>
            <textarea id="prompt" rows="8" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æŒ‡ä»¤..."></textarea>
            <div class="token-counter" id="token-count">0 tokens</div>
            <div class="shortcut-hint">æŒ‰ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ</div>
        </div>

        <div class="button-group">
            <button id="submit-btn" class="button">
                <div class="spinner"></div>
                <span>å‘é€</span>
            </button>
            <button id="clear-btn" class="btn-clear button">æ¸…é™¤</button>
        </div>

    </div>

    <div class="status-bar">
        <span id="status">å°±ç»ª</span>
        <span id="response-info"></span>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // å…ƒç´ å¼•ç”¨
        const submitBtn = document.getElementById('submit-btn');
        const clearBtn = document.getElementById('clear-btn');
        const modelSelect = document.getElementById('model');
        const promptInput = document.getElementById('prompt');
        const responseDiv = document.getElementById('response');
        const statusDiv = document.getElementById('status');
        const responseInfo = document.getElementById('response-info');
        const historyList = document.getElementById('history-list');
        //const useContext = document.getElementById('use-context');
        const think = document.getElementById('think');
        const tokenCount = document.getElementById('token-count');
        const local_document = document.getElementById('use-local-document');
        const spinner = submitBtn.querySelector('.spinner');

        // çŠ¶æ€å˜é‡
        let conversationHistory = [];
        let currentContext = [];
        let isStreaming = false;
        let abortController = null;

        // åˆå§‹åŒ–
        updateTokenCount();

        // äº‹ä»¶ç›‘å¬å™¨
        promptInput.addEventListener('input', updateTokenCount);
        clearBtn.addEventListener('click', clearConversation);
        submitBtn.addEventListener('click', handleSubmit);

        // æ·»åŠ å›è½¦å‘é€åŠŸèƒ½
        promptInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                // å¦‚æœæŒ‰ä¸‹äº†Shifté”®ï¼Œå…è®¸æ¢è¡Œ
                if (e.shiftKey) {
                    return;
                }

                // å¦åˆ™é˜»æ­¢é»˜è®¤è¡Œä¸ºå¹¶å‘é€
                e.preventDefault();
                handleSubmit();
            }
        });

        // æ›´æ–°tokenè®¡æ•°
        function updateTokenCount() {
            const text = promptInput.value;
            // ç®€å•ä¼°ç®—ï¼šå¹³å‡è‹±æ–‡å•è¯1.3ä¸ªtokensï¼Œä¸­æ–‡æ±‰å­—2ä¸ªtokens
            const wordCount = text.split(/\s+/).filter(Boolean).length;
            const charCount = text.length;
            const estimatedTokens = Math.round(wordCount * 1.3 + charCount * 0.5);
            tokenCount.textContent = `${estimatedTokens} tokens`;
        }

        // æ¸…é™¤å¯¹è¯
        function clearConversation() {
            conversationHistory = [];
            currentContext = [];
            responseDiv.textContent = 'å¯¹è¯å·²æ¸…é™¤ã€‚è¯·è¾“å…¥æç¤ºè¯å¹¶ç‚¹å‡»å‘é€...';
            statusDiv.textContent = 'å°±ç»ª';
            responseInfo.textContent = '';
            updateHistoryDisplay();
        }
// æäº¤å¤„ç†
        async function handleSubmit() {
            if (isStreaming) {
                abortController.abort();
                isStreaming = false;
                submitBtn.classList.remove('active');
                statusDiv.textContent = 'è¯·æ±‚å·²ä¸­æ­¢';
                return;
            }
            const model = modelSelect.value;
            const prompt = promptInput.value;

            if (!prompt.trim()) {
                statusDiv.textContent = 'æç¤ºè¯ä¸èƒ½ä¸ºç©º';
                return;
            }
            let content={"role": "user","content": prompt};
            currentContext.push(content);
            // æ·»åŠ ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            //if (currentContext.length > 0) {
            //    message.push(currentContext);
            //}
            // å‡†å¤‡è¯·æ±‚æ•°æ®
            const requestData = {
                model: model,
                messages: currentContext,
                stream: true
            };
            //å¯åŠ¨æ£€ç´¢çŸ¥è¯†åº“
            if (local_document.checked) {
                requestData.tag = true;
            }
            if (think.checked) {
                requestData.think_tag = true;
            }

            // æ›´æ–°UIçŠ¶æ€
            isStreaming = true;
            abortController = new AbortController();
            submitBtn.classList.add('active');
            submitBtn.querySelector('span').textContent = 'åœæ­¢';
            statusDiv.textContent = 'è¿æ¥ä¸­...';
            responseInfo.textContent = '';

            try {
                const response = await fetch('/ai_generate_chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    signal: abortController.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedText = '';
                let buffer = ''; // âœ… æ·»åŠ ç¼“å†²åŒº

                statusDiv.textContent = 'æ¥æ”¶ä¸­...';

                // å¤„ç†æµå¼å“åº”
                while (true) {
                    const {done, value} = await reader.read();

                    if (done) {
                        break;
                    }

                    // è§£ç å¹¶å¤„ç†æ•°æ®å—
                    const chunk = decoder.decode(value, {stream: true}); // âœ… æ·»åŠ  stream: true
                    buffer += chunk; // âœ… å°†chunkæ·»åŠ åˆ°ç¼“å†²åŒº

                    // å¤„ç†ç¼“å†²åŒºä¸­çš„å®Œæ•´è¡Œ
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // ä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„è¡Œ

                    for (const line of lines) {
                        if (line.trim() === '') continue;

                        try {
                            const data = JSON.parse(line);

                            if (data.type === 'source_info') {
                                var dc = "\n\nå‚è€ƒæ–‡æ¡£ï¼š\n";
                                var document_match=data.source;

                            }

                            if (data.message?.content || '') {

                                var responses=data.message?.content || '';
                                accumulatedText += responses;
                                responseDiv.textContent = accumulatedText;
                                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                                responseDiv.parentElement.scrollTop = responseDiv.parentElement.scrollHeight;
                            }

                            if (data.done) {
                                // ä¿å­˜ä¸Šä¸‹æ–‡ä»¥ä¾›ä¸‹ä¸€æ¬¡ä½¿ç”¨
                                if (accumulatedText) {
                                    var history={"role": "assistant","content": accumulatedText};
                                    currentContext.push(history);
                                }
                                responseDiv.textContent = accumulatedText +(dc||'');
                                if (dc){
                                const match = document_match.match(/ã€Š(.*?)ã€‹/);
                                const matchs = [...document_match.matchAll(/ã€Š(.*?)ã€‹/g)].map(match => match[1]);
                                var matches=[...new Set(matchs)];
                                for (var document_name of matches) {
                                    var link = document.createElement('a');
                                    // 2. è®¾ç½®å±æ€§
                                    link.href = '/download/' + document_name; // ä¸‹è½½åœ°å€
                                    link.download = document_name;        // ä¸‹è½½æ—¶çš„æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰
                                    link.textContent = 'ğŸ“„ ã€Š' + document_name + 'ã€‹'; // é“¾æ¥æ˜¾ç¤ºæ–‡å­—

                                    // 3. ï¼ˆå¯é€‰ï¼‰æ·»åŠ æ ·å¼æˆ–ç±»å
                                    link.style.color = 'blue';
                                    link.style.textDecoration = 'underline';
                                    link.classList.add('download-link');
                                    link.style.display = 'block';

                                    // 4. æ’å…¥åˆ°é¡µé¢ä¸­ï¼ˆæ¯”å¦‚æŸä¸ªå®¹å™¨å†…ï¼‰
                                    responseDiv.appendChild(link);
                                }
                                }

                                // æ·»åŠ åˆ°å¯¹è¯å†å²
                                const historyItem = {
                                    prompt: prompt,
                                    response: accumulatedText+ (dc || ''),
                                    model: model,
                                    timestamp: new Date(),
                                    matches:matches
                                };
                                conversationHistory.push(historyItem);
                                // æ›´æ–°UI
                                updateHistoryDisplay();
                                statusDiv.textContent = 'å®Œæˆ';
                                responseInfo.textContent = `è€—æ—¶: ${(data.total_duration / 1e9).toFixed(2)}s, Tokens: ${data.eval_count}`;
                                // æ¸…ç©ºè¾“å…¥æ¡†
                                promptInput.value = '';
                                updateTokenCount();
                            }
                        } catch (e) {
                            console.error('è§£æJSONå‡ºé”™:', e, 'åŸå§‹æ•°æ®:', line);
                        }
                    }
                }

                // å¤„ç†ç¼“å†²åŒºä¸­å‰©ä½™çš„æ•°æ®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                if (buffer.trim()) {
                    try {
                        const data = JSON.parse(buffer.trim());
                        // å¤„ç†æœ€åçš„JSONæ•°æ®
                        if (data.response) {
                            accumulatedText += data.response;
                            responseDiv.textContent = accumulatedText;
                        }
                    } catch (e) {
                        console.error('è§£ææœ€åçš„JSONå‡ºé”™:', e, 'åŸå§‹æ•°æ®:', buffer);
                    }
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    statusDiv.textContent = 'è¯·æ±‚å·²ä¸­æ­¢';
                } else {
                    console.error('è¯·æ±‚å‡ºé”™:', error);
                    statusDiv.textContent = `é”™è¯¯: ${error.message}`;
                }
            } finally {
                isStreaming = false;
                submitBtn.classList.remove('active');
                submitBtn.querySelector('span').textContent = 'å‘é€';
            }
        }
// æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            historyList.innerHTML = '';

            if (conversationHistory.length === 0) {
                historyList.innerHTML = '<div class="empty-history">æš‚æ— å†å²è®°å½•</div>';
                return;
            }

            // æ˜¾ç¤ºæœ€è¿‘10æ¡å†å²è®°å½•ï¼ˆå€’åºæ˜¾ç¤ºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
            const recentHistory = [...conversationHistory].reverse().slice(0, 10);

            recentHistory.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';

                // æ ¼å¼åŒ–æ—¶é—´
                const timeString = item.timestamp.toLocaleTimeString();

                historyItem.innerHTML = `
                        <div class="history-prompt">${item.prompt}</div>
                        <div class="history-response">${item.response.substring(0, 80)}${item.response.length > 80 ? '...' : ''}</div>
                        <div class="history-meta">
                            <span>${item.model}</span>
                            <span>${timeString}</span>
                        </div>
                    `;

                historyItem.addEventListener('click', () => {
                    // ç‚¹å‡»å†å²é¡¹å¯ä»¥é‡æ–°åŠ è½½åˆ°å“åº”åŒºåŸŸ
                    responseDiv.textContent = item.response;
                    var matches=item.matches;
                    if (matches) {
                        for (var document_name of matches) {
                            var link = document.createElement('a');
                            // 2. è®¾ç½®å±æ€§
                            link.href = '/download/' + document_name; // ä¸‹è½½åœ°å€
                            link.download = document_name;        // ä¸‹è½½æ—¶çš„æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰
                            link.textContent = 'ğŸ“„ ã€Š' + document_name + 'ã€‹'; // é“¾æ¥æ˜¾ç¤ºæ–‡å­—

                            // 3. ï¼ˆå¯é€‰ï¼‰æ·»åŠ æ ·å¼æˆ–ç±»å
                            link.style.color = 'blue';
                            link.style.textDecoration = 'underline';
                            link.classList.add('download-link');
                            link.style.display = 'block';

                            // 4. æ’å…¥åˆ°é¡µé¢ä¸­ï¼ˆæ¯”å¦‚æŸä¸ªå®¹å™¨å†…ï¼‰
                            responseDiv.appendChild(link);
                        }
                    }
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    responseDiv.parentElement.scrollTop = responseDiv.parentElement.scrollHeight;
                });

                historyList.appendChild(historyItem);
            });
        }
    });


    document.getElementById('multiple-upload-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        uploadFile('fileinput', formData);
    });


    function uploadFile(id, formData) {
        const input = document.getElementById(id);
        const files = input.files; // è·å–æ–‡ä»¶

        for (let i = 0; i < files.length; i++) {
            if (files[i] != undefined) {
                // åˆ›å»ºFormDataå¯¹è±¡ç”¨äºæ„å»ºè¡¨å•æ•°æ®é›†
                formData.append('file' + i, files[i]);
            }
        } // å°†æ–‡ä»¶æ·»åŠ åˆ°FormDataä¸­
        if (files.length != 0) {
            // åˆ›å»ºAJAXè¯·æ±‚å‘é€æ–‡ä»¶
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/ai_generate_chat', true); // '/upload' æ˜¯æœåŠ¡å™¨ä¸Šå¤„ç†ä¸Šä¼ çš„è·¯å¾„
            xhr.onload = function () {
                 if (this.status == 200) {
                    input.value = ''
                    console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                    alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                } else {
                    //console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                    alert(this.response);
					input.value = ''
                    {
                        // alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥')
                    }
                }
            };
            xhr.send(formData);
        }
    }
</script>
</body>
</html>